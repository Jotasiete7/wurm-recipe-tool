# Current Issue: Recipe Deletion Constraint

**Date:** 2026-02-19
**Status:** Unresolved / Pending Diagnosis

## Problem Description

Users cannot delete recipes from the frontend. The operation fails with a foreign key constraint error, despite attempting to apply `ON DELETE CASCADE` via SQL.

**Frontend Error:**

```
Failed to delete recipe: Error: Cannot delete recipe because it has associated logs not set to cascade delete. Please contact admin to fix database constraints.
```

*Note: This specific error message is generated by the frontend when catching error code `23503`.*

**Underlying Database Error:**

```
update on table "recipe_audit_log" violates foreign key constraint "recipe_audit_log_recipe_id_fkey"
key (recipe_id)=(...) is still referenced from table "recipe_audit_log".
```

## Diagnosis Attempts & Fixes Applied

1. **Frontend Manual Deletion:**
   - Tried to manually delete logs before deleting the recipe in `RecipeEditModal.tsx`.
   - **Result:** Failed with `404 Not Found` for the log table (possibly permission issue). Reverted this change to rely on DB constraints.

2. **Database Constraint Fix (SQL):**
   - Created `supabase/force_fix.sql` to DROP the existing constraint and ADD a new one with `ON DELETE CASCADE`.
   - **Status:** User reported "Constraint applied successfully", but the error persists.

## Hypotheses for Next Agent

1. **Wrong Constraint Target:** The error might be coming from a *different* table or constraint (e.g., `recipes_audit_log` plural vs singular, or a hidden trigger/function).
2. **Transaction Isolation:** The constraint change might not have been fully committed or propagated when the test was run.
3. **Ghost Constraint:** PostgREST cache might hold onto old schema info. (Running `NOTIFY pgrst, 'reload schema'` might help).

## Recommended Next Steps

1. **Run Diagnosis:** Execute `supabase/debug_constraints.sql` (already created in repo) in the Supabase SQL Editor to list ALL active foreign keys pointing to the `recipes` table.

   ```sql
   SELECT conname, conrelid::regclass, confdeltype FROM pg_constraint WHERE confrelid = 'recipes'::regclass;
   ```

2. **Identify Blocking Constraint:** Check the output for any constraint where `confdeltype` is NOT 'c' (Cascade).
3. **Reload Schema Cache:** Run `NOTIFY pgrst, 'reload schema';` in SQL Editor to force PostgREST to refresh its schema cache.
